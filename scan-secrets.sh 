#!/usr/bin/env bash

echo "==============================================="
echo " üîç NODE AUTH STACK DANGER SCAN"
echo "==============================================="
echo

echo "1Ô∏è‚É£  Checking for any return of user object that might leak secrets..."
grep -R --line-number --color=always -E "return[^;]*user" ./src \
--exclude="scan-secrets.sh" \
  | grep -v "toSafeUser" \
  | grep -v "safeUser" \
  | grep -v "@safe" \
  || echo "   ‚úî No leaks"

echo
echo "2Ô∏è‚É£  Checking for direct usage of two_factor_secret in responses or logs..."
grep -R --line-number --color=always -E "res\.json|return|console\.|JSON\.stringify" ./src \
  --exclude-dir=generated \
  --exclude-dir=types \
| grep "two_factor_secret" \
|| echo "   ‚úî No leaks"

echo
echo "3Ô∏è‚É£  Checking for direct usage of two_factor_recovery_codes..."
grep -R --line-number --color=always -E "res\.json|return|console\.|JSON\.stringify" ./src \
  --exclude-dir=generated \
  --exclude-dir=types \
| grep "two_factor_recovery_codes" \
|| echo "   ‚úî No leaks"

echo
echo "4Ô∏è‚É£  Checking for leaked tokens in responses..."
# 1. Leaks in logs
grep -R --line-number --color=always -E "console\." ./src \
  | grep -E "access_token|refresh_token|\"token\":|token:|Bearer " \
  || echo "   ‚úî No token leaks in logs"

# Leaks in error responses (exclude natural-language 'token' occurrences)
grep -R --line-number --color=always -E "res\.status" ./src \
  | grep -E "access_token|refresh_token|\"token\":|token:|Bearer " \
  | grep -v "200" \
  | grep -v "201" \
  || echo "   ‚úî No token leaks in error responses"

# Leaks in non-auth responses
grep -R --line-number --color=always -E "res\.json" ./src \
  | grep -E "access_token|refresh_token|\"token\":|token:|Bearer " \
  | grep -v "/auth" \
  || echo "   ‚úî No unintended token leaks in non-auth responses"


echo
echo "5Ô∏è‚É£  Checking for console logs that may contain sensitive info..."
grep -R --line-number --color=always -E "console\.log|console\.error" ./src \
|| echo "   ‚úî No console logs"


echo
echo "6Ô∏è‚É£  Checking Redis writes for full user objects..."
grep -R --line-number --color=always "JSON.stringify" ./src \
  | grep -E "JSON\.stringify\((user|req\.user|\{[^\}]*user[^\}]*\})" \
  | grep -v "toSafeUser" \
  | grep -v "safeUser" \
  || echo "   ‚úî No raw user objects cached in Redis"

echo
echo "7Ô∏è‚É£  Checking for any response that returns the entire 'user' object unsafely..."
grep -R --line-number --color=always \
  -E "res\.json|return" \
  --exclude="scan-secrets.sh" \
  ./src \
| grep -E "return[^(]*\buser\b|res\.json\([^{]*\buser\b" \
| grep -v "toSafeUser" \
| grep -v "safeUser" \
| grep -v "@safe" \
|| echo "   ‚úî No unsafe full user objects returned"

echo
echo "==============================================="
echo " üßπ SCAN COMPLETE: Review any highlighted lines"
echo "==============================================="
